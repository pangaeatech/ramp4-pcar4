import{cI as $,f as F,bK as S,by as w}from"./main-59LucoDB.js";import{R as h}from"./normalizeUtils-DNEBpgqm.js";import{B as T,x as j,j as g}from"./queryUtils-DIvO58fg.js";import{d as v,O,V as Q}from"./QueryEngine-RB2w0-lH.js";import{I as q}from"./timeSupport-CMBQ_C0U.js";async function B(e,n,u){const a=$(u),{point:t,distance:i,returnEdge:f,vertexMode:m}=n;if(!f&&m==="none")return{candidates:[]};let r=F(n.query);r=await e.schedule(()=>T(r,e.definitionExpression,e.spatialReference),a),r=await e.reschedule(()=>v(r,{availableFields:e.availableFields,fieldsIndex:e.fieldsIndex,geometryType:e.geometryType,spatialReference:e.spatialReference}),a);const o=!S(t.spatialReference,e.spatialReference);o&&await j(t.spatialReference,e.spatialReference);const p=typeof i=="number"?i:i.x,d=typeof i=="number"?i:i.y,y={xmin:t.x-p,xmax:t.x+p,ymin:t.y-d,ymax:t.y+d,spatialReference:t.spatialReference},s=o?g(y,e.spatialReference):y;if(!s)return{candidates:[]};const x=(await h(w(t),null,{signal:a}))[0],c=(await h(w(s),null,{signal:a}))[0];if(x==null||c==null)return{candidates:[]};const l=new O(await e.reschedule(()=>e.searchFeatures(Q(c.toJSON())),a),r,e);await e.reschedule(()=>e.executeObjectIdsQuery(l),a),await e.reschedule(()=>e.executeTimeQuery(l),a),await e.reschedule(()=>e.executeAttributesQuery(l),a),await e.reschedule(()=>E(e,l,a),a);const R=x.toJSON(),b=o?g(R,e.spatialReference):R,I=o?Math.max(s.xmax-s.xmin,s.ymax-s.ymin)/2:i;return l.createSnappingResponse({...n,point:b,distance:I},r.returnZ,t.spatialReference)}async function E(e,n,u){const{query:a}=n,{spatialRel:t}=a;if(!n?.items?.length||!a.geometry||!t)return;const i=await q(t,a.geometry,e.geometryType,e.hasZ,e.hasM),f=await e.runSpatialFilter(n.items,m=>i(m.geometry),u);n.items=f}export{B as u};
